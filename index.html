<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ZaroratPay — Mini App (Full)</title>

<!-- Telegram Web App SDK -->
<script async src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Montage / libtl Ads SDK (zone 10088330) -->
<script async src="//libtl.com/sdk.js" data-zone="10088330" data-sdk="show_10088330"></script>

<style>
  :root{--primary:#0088cc;--bg:#f4f7fb;--card:#fff;--radius:12px;--maxw:480px}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial; background:var(--bg); margin:0; padding:20px; display:flex;justify-content:center}
  .app{width:100%; max-width:var(--maxw)}
  .splash{background:linear-gradient(90deg,var(--primary),#00b8d4); color:#fff; padding:28px; border-radius:14px; text-align:center}
  .card{background:var(--card); padding:14px; border-radius:var(--radius); margin-top:12px; box-shadow:0 6px 18px rgba(13,27,43,0.06)}
  .row{display:flex;align-items:center;gap:12px}
  .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid #fff}
  h1,h2,h3{margin:6px 0}
  .small{font-size:13px;color:#555}
  .btn{background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
  .btn.ghost{background:transparent; color:var(--primary); border:1px solid rgba(0,136,204,0.12)}
  input,select{width:100%; padding:10px; border-radius:8px; border:1px solid #e6eef6; margin-top:8px}
  nav.bottom{position:fixed; left:50%; transform:translateX(-50%); bottom:12px; max-width:var(--maxw); width:100%; display:flex; gap:8px}
  nav.bottom button{flex:1}
  .hidden{display:none}
  .tx-item{padding:8px;border-bottom:1px solid #f4f6f8}
  .warn{background:#fff7e6;padding:8px;border-radius:8px;color:#6b3b00}
  .center{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
  <div class="app">

    <!-- SPLASH -->
    <div id="splash" class="splash">
      <h1>ZaroratPay</h1>
      <p class="small">Open this mini app from Telegram for automatic login & ads rewards</p>
      <div style="margin-top:12px"><button class="btn" onclick="enterApp()">Open App</button></div>
    </div>

    <!-- MAIN -->
    <div id="main" class="hidden">

      <!-- PROFILE CARD -->
      <div class="card">
        <div class="row">
          <img id="profilePhoto" class="avatar" src="https://via.placeholder.com/100" alt="photo">
          <div style="flex:1">
            <h2 id="profileName">Guest</h2>
            <div class="small" id="profileUsername"></div>
            <div class="small">Balance: <strong id="balance">0.00</strong> AFN</div>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="watchAdBtn" class="btn">Watch Ad — Earn 0.15 AFN</button>
          <button class="btn ghost" onclick="showSection('wallet')">Wallet</button>
          <button class="btn ghost" onclick="showSection('topup')">Top-up</button>
        </div>

        <div id="adsInfo" class="small" style="margin-top:8px"></div>
      </div>

      <!-- HOME CARD -->
      <div id="home" class="card">
        <h3>Home</h3>
        <p class="small">Daily bonus: 1 AFN (once per day). Referral: 2 AFN per successful referred user.</p>

        <div id="adContainer" style="margin-top:12px">
          <div class="small">Ads will open as popup/overlay from the SDK.</div>
        </div>
      </div>

      <!-- WALLET -->
      <div id="wallet" class="card hidden">
        <h3>Wallet & Transactions</h3>
        <div class="small">Balance: <strong id="walletBalance">0.00</strong> AFN</div>
        <div style="margin-top:12px">
          <h4>Transactions</h4>
          <div id="txList" class="small">Loading...</div>
        </div>
        <div style="margin-top:12px">
          <h4>Withdraw</h4>
          <label>Method (e.g., Mobile number)</label>
          <input id="withdrawTo" placeholder="07XXXXXXXX"/>
          <label>Amount (AFN)</label>
          <input id="withdrawAmount" type="number" min="1" value="100"/>
          <div style="margin-top:8px" class="row">
            <button class="btn" onclick="requestWithdraw()">Request Withdraw</button>
            <button class="btn ghost" onclick="showSection('home')">Cancel</button>
          </div>
          <div id="withdrawStatus" class="small" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- TOPUP -->
      <div id="topup" class="card hidden">
        <h3>Mobile Top-up</h3>
        <label>Operator</label>
        <select id="operator"><option>Roshan</option><option>Etisalat</option><option>AWCC</option><option>MTN</option></select>
        <label>Phone number</label>
        <input id="phone" placeholder="07XXXXXXXX"/>
        <label>Amount (AFN) — minimum 25</label>
        <input id="topupAmount" type="number" min="25" value="25"/>
        <div style="margin-top:10px" class="row">
          <button class="btn" onclick="doTopup()">Top-up Now</button>
          <button class="btn ghost" onclick="showSection('wallet')">View Wallet</button>
        </div>
        <div id="topupStatus" class="small" style="margin-top:8px"></div>
      </div>

      <!-- LEADERBOARD -->
      <div id="leaderboard" class="card hidden">
        <h3>Leaderboard — Top 10</h3>
        <div id="leaderboardList" class="small">Loading...</div>
      </div>

      <!-- PROFILE -->
      <div id="profile" class="card hidden">
        <h3>Profile</h3>
        <div class="small">Name: <strong id="pName"></strong></div>
        <div class="small">Username: <strong id="pUsername"></strong></div>
        <div class="small">Telegram ID: <strong id="pId"></strong></div>
        <div class="small" style="margin-top:8px">Ads today: <strong id="pAds">0</strong>/20</div>
      </div>

    </div>

    <!-- bottom nav -->
    <nav class="bottom">
      <button class="btn ghost" onclick="showSection('home')">Home</button>
      <button class="btn ghost" onclick="showSection('leaderboard')">Leaderboard</button>
      <button class="btn ghost" onclick="showSection('wallet')">Wallet</button>
      <button class="btn ghost" onclick="showSection('profile')">Profile</button>
    </nav>
  </div>

<script>
/* =======================
   CONFIG
   ======================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDCcKpU-6lPnjn7NSTZVq6R5HGLac2GlAk",
  authDomain: "zaroratpay.firebaseapp.com",
  databaseURL: "https://zaroratpay-default-rtdb.firebaseio.com",
  projectId: "zaroratpay",
  storageBucket: "zaroratpay.firebasestorage.app",
  messagingSenderId: "992212281257",
  appId: "1:992212281257:web:bf5e442cc2636725ee06b8"
};
const AD_REWARD = 0.15;
const DAILY_LIMIT = 20;
const AD_ZONE_FN_PREFIX = 'show_'; // SDK exposes functions named like show_10088330

/* =======================
   INIT FIREBASE
   ======================= */
firebase.initializeApp(FIREBASE_CONFIG);
const rdb = firebase.database();

/* =======================
   TELEGRAM INIT
   ======================= */
let tg=null;
try { tg = window.Telegram.WebApp; tg.expand(); } catch(e){ tg=null; }
const tgUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
const uid = tgUser ? String(tgUser.id) : ('guest_' + Math.random().toString(36).slice(2,9));
let state = { balance:0, ads_today:0, ads_date:'' };

/* =======================
   UTILITIES
   ======================= */
function todayISO(){ const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function fmt(n){ return Number(n||0).toFixed(2); }
function showSection(id){
  const sections = ['home','wallet','topup','leaderboard','profile'];
  sections.forEach(s => document.getElementById(s).classList.toggle('hidden', s!==id));
  if(id==='wallet') loadTransactions();
  if(id==='leaderboard') loadLeaderboard();
  if(id==='profile') renderProfile();
}

/* =======================
   APP START
   ======================= */
function enterApp(){
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  initApp();
}

function initApp(){
  // fill profile from Telegram
  if(tgUser){
    document.getElementById('profilePhoto').src = tgUser.photo_url || 'https://via.placeholder.com/100';
    document.getElementById('profileName').innerText = tgUser.first_name || 'User';
    document.getElementById('profileUsername').innerText = tgUser.username ? '@'+tgUser.username : '';
    document.getElementById('pName').innerText = (tgUser.first_name||'') + ' ' + (tgUser.last_name||'');
    document.getElementById('pUsername').innerText = tgUser.username || '';
    document.getElementById('pId').innerText = uid;
  } else {
    document.getElementById('profileName').innerText = 'Guest';
  }

  // ensure user record exists & sync state
  const uRef = rdb.ref('users/'+uid);
  uRef.once('value').then(snap => {
    const nowDay = todayISO();
    if(!snap.exists()){
      uRef.set({
        id: uid,
        first_name: tgUser ? tgUser.first_name : 'Guest',
        username: tgUser ? tgUser.username : '',
        photo: tgUser ? tgUser.photo_url : '',
        balance: 0,
        ads_today: 0,
        ads_date: nowDay,
        referrals: 0,
        joinedAt: Date.now(),
        lastLogin: Date.now()
      });
      state = { balance:0, ads_today:0, ads_date: nowDay };
      updateUI();
    } else {
      const data = snap.val();
      // reset daily if date changed
      if(!data.ads_date || data.ads_date !== nowDay){
        uRef.update({ ads_today:0, ads_date: nowDay });
        data.ads_today = 0; data.ads_date = nowDay;
      }
      state.balance = Number(data.balance || 0);
      state.ads_today = Number(data.ads_today || 0);
      state.ads_date = data.ads_date || nowDay;
      updateUI();
    }
    // run daily bonus check
    dailyBonusCheck();
  });

  // wire ad button
  document.getElementById('watchAdBtn').addEventListener('click', () => {
    playRewardedAd();
  });

  // referral share
  document.getElementById('profileUsername').addEventListener('click', () => {
    // optional quick share
  });

  // topup and withdraw buttons handled by functions below

  // listen user node for live updates
  rdb.ref('users/'+uid).on('value', snap => {
    const d = snap.val() || {};
    state.balance = Number(d.balance || 0);
    state.ads_today = Number(d.ads_today || 0);
    state.ads_date = d.ads_date || todayISO();
    updateUI();
  });

  // check if page URL includes Telegram start param for referral (when user opens bot with ?start=refid)
  handleReferral();
  loadLeaderboard();
}

/* =======================
   UI updates
   ======================= */
function updateUI(){
  document.getElementById('balance').innerText = fmt(state.balance);
  document.getElementById('walletBalance').innerText = fmt(state.balance);
  document.getElementById('adsInfo').innerText = `Ads today: ${state.ads_today}/${DAILY_LIMIT}`;
  document.getElementById('adsToday') && (document.getElementById('adsToday').innerText = `Ads today: ${state.ads_today}/${DAILY_LIMIT}`);
  document.getElementById('pAds').innerText = state.ads_today;
}

/* =======================
   REWARD: atomic transaction
   ======================= */
function grantRewardAtomic(reward=AD_REWARD){
  const userRef = rdb.ref('users/'+uid);
  return userRef.transaction(u => {
    if(!u) return u;
    const curDay = todayISO();
    if(!u.ads_date || u.ads_date !== curDay){
      u.ads_date = curDay;
      u.ads_today = 0;
    }
    if((u.ads_today||0) >= DAILY_LIMIT){
      return u; // no change — transaction will commit but we must detect
    }
    u.ads_today = (u.ads_today||0) + 1;
    u.balance = Number(((u.balance||0) + Number(reward)).toFixed(6));
    return u;
  }, (err, committed, snapshot) => {
    if(err){ console.error('grant tx err', err); alert('Error processing reward.'); return; }
    if(!committed){
      alert(`You have reached daily limit of ${DAILY_LIMIT} ads.`);
      return;
    }
    // record transaction
    const txRef = rdb.ref('transactions').push();
    const tx = { id: txRef.key, uid, type: 'reward', amount: reward, timestamp: Date.now() };
    txRef.set(tx);
    // UI updated via on('value') listener
  });
}

/* =======================
   AD PLAYING logic
   - tries to find global SDK function like show_10088330
   - calls it (try several signatures)
   - if promise resolves -> grant reward
   - if SDK uses callback -> listen for global callback names
   - fallback: ask user to confirm ad watched
   ======================= */
function findAdFn(){
  // Try exact name first (data-sdk defined by script tag)
  if(typeof window.show_10088330 === 'function') return window.show_10088330;
  // try other show_ prefixed
  for(const k in window){
    if(k.startsWith && typeof k === 'string' && k.startsWith('show_') && typeof window[k] === 'function'){
      return window[k];
    }
  }
  return null;
}

async function playRewardedAd(){
  if(!tg){
    alert('Open app inside Telegram to earn rewards.');
    return;
  }
  // check local daily count
  if(state.ads_today >= DAILY_LIMIT){
    alert(`You have reached the daily limit (${DAILY_LIMIT}) of ads.`);
    return;
  }

  const adFn = findAdFn();
  if(!adFn){
    alert('Ad SDK not loaded or zone ID incorrect. See console for details.');
    console.warn('No ad function found on window.');
    return;
  }

  // Try typical call patterns
  try {
    let res;
    // many libtl SDK calls support a 'pop' or no-arg call and return Promise
    try { res = adFn('pop'); } catch(e1) {
      try { res = adFn({type:'rewarded'}); } catch(e2) {
        try { res = adFn(); } catch(e3){ res = undefined; }
      }
    }

    if(res && typeof res.then === 'function'){
      // Promise-based SDK
      await res;
      await grantRewardAtomic(AD_REWARD);
      alert(`✅ You earned ${AD_REWARD} AFN`);
      return;
    }

    // If not promise: set up fallback listeners for common global callbacks
    let rewarded = false;
    const cbNames = ['onAdComplete','onReward','on_ad_complete','onRewarded','onAdClosed'];
    const originals = {};
    cbNames.forEach(name => {
      originals[name] = window[name];
      window[name] = function(...args){
        rewarded = true;
        try { grantRewardAtomic(AD_REWARD); } catch(e){ console.error(e); }
        // restore original
        window[name] = originals[name];
      };
    });

    // give SDK a short time to trigger callback
    await new Promise(r => setTimeout(r, 7000));
    if(rewarded) { alert(`✅ You earned ${AD_REWARD} AFN`); return; }

    // fallback: ask user to confirm
    const ok = confirm('If you watched the full ad, press OK to receive reward.');
    if(ok){ await grantRewardAtomic(AD_REWARD); alert(`✅ You earned ${AD_REWARD} AFN`); }
    else alert('No reward given. Watch full ad to get reward.');

  } catch(err){
    console.error('Ad play error', err);
    alert('Ad error: check console and ensure SDK/zone is active.');
  }
}

/* =======================
   REFERRAL handling (credit referrer once)
   - we expect a URL param ?start=REFID (common Telegram bot start)
   ======================= */
function handleReferral(){
  const urlParams = new URLSearchParams(window.location.search);
  const refId = urlParams.get('start') || urlParams.get('ref');
  if(refId && refId !== uid){
    const refLogKey = `referrals_claimed/${uid}`; // record to avoid double credit
    rdb.ref(refLogKey).once('value').then(snap=>{
      if(snap.exists()){
        console.log('Referral already processed for this user.');
        return;
      }
      // credit the referrer atomically
      const refUserRef = rdb.ref('users/' + refId);
      refUserRef.transaction(u => {
        if(!u) return u;
        u.balance = Number((Number(u.balance || 0) + 2).toFixed(6));
        u.referrals = (u.referrals || 0) + 1;
        return u;
      }, (err, committed) => {
        if(err){ console.error('ref tx err', err); return; }
        if(committed){
          // mark referral processed for this new user
          rdb.ref(refLogKey).set({ refId: refId, timestamp: Date.now() });
          // create tx record
          const txRef = rdb.ref('transactions').push();
          txRef.set({ id: txRef.key, uid: refId, type:'referral', amount:2, from: uid, timestamp: Date.now() });
          console.log('Referral credited to', refId);
        }
      });
    });
  }
}

/* =======================
   DAILY BONUS: 1 AFN once per day
   ======================= */
function dailyBonusCheck(){
  const userRef = rdb.ref('users/' + uid);
  userRef.once('value').then(snap=>{
    const data = snap.val() || {};
    const lastLogin = data.lastLogin || 0;
    const todayStart = new Date().setHours(0,0,0,0);
    if(!lastLogin || lastLogin < todayStart){
      // credit 1 AFN
      userRef.transaction(u => {
        if(!u) return u;
        u.balance = Number(((u.balance||0) + 1).toFixed(6));
        u.lastLogin = Date.now();
        return u;
      }, (err,committed,snap2) => {
        if(committed) alert('🎁 Daily Bonus: 1 AFN added!');
      });
    }
  });
}

/* =======================
   TRANSACTIONS / TOPUP / WITHDRAW
   ======================= */
function loadTransactions(){
  const el = document.getElementById('txList');
  el.innerHTML = 'Loading...';
  rdb.ref('transactions').orderByChild('uid').equalTo(uid).limitToLast(50).once('value').then(snap=>{
    const arr=[]; snap.forEach(ch=> arr.push(ch.val()));
    arr.sort((a,b)=> b.timestamp - a.timestamp);
    if(arr.length===0){ el.innerHTML = '<div class="small">No transactions yet.</div>'; return; }
    el.innerHTML = arr.map(tx=>`<div class="tx-item"><strong>${tx.type}</strong> — ${fmt(tx.amount||0)} AFN <div class="small">${new Date(tx.timestamp).toLocaleString()}</div></div>`).join('');
  }).catch(e=> { el.innerHTML = 'Error loading.'; console.error(e); });
}

function doTopup(){
  if(!tg){ alert('Open inside Telegram to top-up.'); return; }
  const phone = document.getElementById('phone').value.trim();
  const op = document.getElementById('operator').value;
  const amt = Number(document.getElementById('topupAmount').value || 0);
  const status = document.getElementById('topupStatus');
  status.innerText = '';
  if(!phone || phone.length < 7){ status.innerText = 'Enter valid phone.'; return; }
  if(amt < 25){ status.innerText = 'Top-up must be at least 25 AFN.'; return; }

  // deduct from user balance atomically
  const balRef = rdb.ref('users/'+uid+'/balance');
  balRef.transaction(cur => {
    if((cur||0) < amt) return; // abort
    return (cur||0) - amt;
  }, (err, committed, snap) => {
    if(err){ status.innerText = 'Error processing top-up.'; console.error(err); return; }
    if(!committed){ status.innerText = 'Insufficient balance.'; return; }
    // record transaction and topup entry
    const txRef = rdb.ref('transactions').push();
    const tx = { id: txRef.key, uid, type:'topup', operator:op, phone, amount:amt, timestamp: Date.now(), status:'success' };
    txRef.set(tx);
    rdb.ref('topups').push(tx);
    status.innerText = `Top-up successful: ${fmt(amt)} AFN to ${phone} (${op})`;
    loadTransactions();
    loadBalanceOnce();
  });
}

function requestWithdraw(){
  if(!tg){ alert('Open inside Telegram to withdraw.'); return; }
  const to = document.getElementById('withdrawTo').value.trim();
  const amt = Number(document.getElementById('withdrawAmount').value || 0);
  const status = document.getElementById('withdrawStatus');
  status.innerText = '';
  if(!to || to.length < 5){ status.innerText = 'Enter withdrawal destination.'; return; }
  if(amt <= 0){ status.innerText = 'Enter valid amount.'; return; }

  // atomic check & deduct
  const balRef = rdb.ref('users/'+uid+'/balance');
  balRef.transaction(cur => {
    if((cur||0) < amt) return; // abort
    return (cur||0) - amt;
  }, (err, committed, snap) => {
    if(err){ status.innerText = 'Error processing withdraw.'; console.error(err); return; }
    if(!committed){ status.innerText = 'Insufficient balance.'; return; }
    // create withdraw record (admin will process)
    const wRef = rdb.ref('withdraws').push();
    const wobj = { id: wRef.key, uid, to, amount: amt, status: 'pending', timestamp: Date.now() };
    wRef.set(wobj).then(()=>{
      // record transaction
      const txRef = rdb.ref('transactions').push();
      txRef.set({ id: txRef.key, uid, type:'withdraw_request', amount: amt, timestamp: Date.now() });
      status.innerText = 'Withdraw requested — pending approval.';
      loadTransactions();
      loadBalanceOnce();
    }).catch(e=> { status.innerText = 'Withdraw request failed.'; console.error(e); });
  });
}

function loadBalanceOnce(){
  rdb.ref('users/'+uid+'/balance').once('value').then(snap=>{
    state.balance = Number(snap.exists()?snap.val():0);
    updateUI();
  });
}

/* =======================
   LEADERBOARD
   ======================= */
function loadLeaderboard(){
  const el = document.getElementById('leaderboardList');
  el.innerHTML = 'Loading...';
  rdb.ref('users').orderByChild('balance').limitToLast(10).once('value').then(snap=>{
    const arr=[]; snap.forEach(ch=> arr.push(ch.val()));
    arr.sort((a,b)=> (b.balance||0)-(a.balance||0));
    if(arr.length===0){ el.innerHTML = '<div class="small">No users yet.</div>'; return; }
    el.innerHTML = arr.map((u,idx)=>`<div style="padding:8px 0;border-bottom:1px solid #f4f6f8"><strong>#${idx+1} ${u.first_name||u.name||'User'}</strong> — ${fmt(u.balance||0)} AFN</div>`).join('');
  }).catch(e=> { el.innerHTML = 'Error'; console.error(e); });
}

/* =======================
   RENDER PROFILE
   ======================= */
function renderProfile(){
  document.getElementById('pName').innerText = tgUser ? (tgUser.first_name||'') + ' ' + (tgUser.last_name||'') : 'Guest';
  document.getElementById('pUsername').innerText = tgUser ? (tgUser.username || '') : '';
  document.getElementById('pId').innerText = uid;
  document.getElementById('pAds').innerText = state.ads_today || 0;
}

/* =======================
   REFERRAL: immediate share link
   ======================= */
function shareReferral(){
  if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user){ alert('Open inside Telegram to share referral'); return; }
  const myId = String(tg.initDataUnsafe.user.id);
  // share bot start link
  const botUsername = 'YourMiniAppBot'; // <<< CHANGE to your bot username
  const refLink = `https://t.me/${botUsername}?start=${myId}`;
  try { tg.shareUrl(refLink); } catch(e){ alert('Share: ' + refLink); }
}

/* =======================
   HANDLE Referral on load (if ?start=REFID present)
   ======================= */
function handleReferral(){ /* implemented earlier by initApp call – kept for clarity */ }

/* =======================
   BOOTSTRAP helper on page load
   ======================= */
window.addEventListener('load', ()=>{
  // if user opened via Telegram, show enterApp after small delay
  // otherwise let user click Open App
  // We show splash until user clicks or timeout
  // (enterApp() bound to button)
  // If user opened with tg and wants auto-enter, you can call enterApp() directly
  if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    // optional auto-enter:
    // enterApp();
  }
});

// expose helpers for console debugging
window._zar = {
  grantRewardAtomic, playRewardedAd, doTopup, requestWithdraw, loadLeaderboard
};
</script>
</body>
</html>
