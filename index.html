<!doctype html>
<html lang="ps">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Timuri App â€” MiniApp</title>

<!-- Telegram Web App SDK -->
<script async src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Montage / libtl ad SDKs (multiple tries) -->
<script async src="https://otieu.com/pfe/current/tag.min.js?z=3068852" data-cfasync="false"></script>
<script async src="//libtl.com/sdk.js" data-zone="10088330" data-sdk="show_10088330"></script>
<!-- if you have another script URL, add it here -->

<style>
:root{--primary:#0b84ff;--bg:#f4f7fb;--card:#fff;--radius:12px;--maxw:460px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);display:flex;justify-content:center;padding:18px}
.app{width:100%;max-width:var(--maxw)}
.splash{background:linear-gradient(135deg,var(--primary),#00b8d4);color:#fff;padding:26px;border-radius:14px;text-align:center}
.card{background:var(--card);padding:14px;border-radius:var(--radius);margin-top:12px;box-shadow:0 8px 22px rgba(3,20,70,0.06)}
.row{display:flex;gap:12px;align-items:center}
.avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid #fff}
h1,h2,h3{margin:6px 0}
.small{font-size:13px;color:#555}
.btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,132,255,0.14)}
input,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6eef6}
.hidden{display:none}
.tx-item{padding:8px;border-bottom:1px solid #f4f6f8}
.nav{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;max-width:var(--maxw);width:100%;display:flex;gap:8px}
.nav button{flex:1}
</style>
</head>
<body>
  <div class="app">

    <!-- Splash -->
    <div id="splash" class="splash">
      <h1>Timuri App</h1>
      <p class="small">Open from Telegram for auto-login, ads & rewards</p>
      <div style="margin-top:12px">
        <button class="btn" onclick="enterApp()">Open App</button>
      </div>
    </div>

    <!-- Main -->
    <div id="main" class="hidden">
      <!-- profile -->
      <div class="card">
        <div class="row">
          <img id="profilePhoto" class="avatar" src="https://via.placeholder.com/100" alt="photo">
          <div style="flex:1">
            <h2 id="profileName">Guest</h2>
            <div class="small" id="profileUsername"></div>
            <div class="small">Balance: <strong id="balance">0.00</strong> AFN</div>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="watchAdBtn" class="btn">Watch Ad â€” Earn 0.15 AFN</button>
          <button class="btn ghost" onclick="showSection('wallet')">Wallet</button>
          <button class="btn ghost" onclick="showSection('topup')">Top-up</button>
        </div>

        <div id="adsInfo" class="small" style="margin-top:8px"></div>
      </div>

      <!-- home -->
      <div id="home" class="card">
        <h3>Home</h3>
        <p class="small">Daily bonus: 1 AFN once/day. Referral reward: 2 AFN per successful referral.</p>
        <div id="adContainer" style="margin-top:12px">
          <div class="small">Ads open via SDK overlay / popup (depends on SDK & WebView).</div>
          <div id="adPlaceholder" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- wallet -->
      <div id="wallet" class="card hidden">
        <h3>Wallet & Transactions</h3>
        <div class="small">Balance: <strong id="walletBalance">0.00</strong> AFN</div>
        <div style="margin-top:12px">
          <h4>Transactions</h4>
          <div id="txList" class="small">Loading...</div>
        </div>
        <div style="margin-top:12px">
          <h4>Withdraw</h4>
          <label>Withdraw to (mobile/wallet)</label>
          <input id="withdrawTo" placeholder="07XXXXXXXX"/>
          <label>Amount (AFN)</label>
          <input id="withdrawAmount" type="number" min="1" value="100"/>
          <div style="margin-top:8px" class="row">
            <button class="btn" onclick="requestWithdraw()">Request Withdraw</button>
            <button class="btn ghost" onclick="showSection('home')">Cancel</button>
          </div>
          <div id="withdrawStatus" class="small" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- topup -->
      <div id="topup" class="card hidden">
        <h3>Mobile Top-up</h3>
        <label>Operator</label>
        <select id="operator"><option>Roshan</option><option>Etisalat</option><option>AWCC</option><option>MTN</option></select>
        <label>Phone number</label>
        <input id="phone" placeholder="07XXXXXXXX"/>
        <label>Amount (AFN) â€” minimum 25</label>
        <input id="topupAmount" type="number" min="25" value="25"/>
        <div style="margin-top:10px" class="row">
          <button class="btn" onclick="doTopup()">Top-up Now</button>
          <button class="btn ghost" onclick="showSection('wallet')">View Wallet</button>
        </div>
        <div id="topupStatus" class="small" style="margin-top:8px"></div>
      </div>

      <!-- leaderboard -->
      <div id="leaderboard" class="card hidden">
        <h3>Leaderboard â€” Top 10</h3>
        <div id="leaderboardList" class="small">Loading...</div>
      </div>

      <!-- profile -->
      <div id="profile" class="card hidden">
        <h3>Profile</h3>
        <div class="small">Name: <strong id="pName"></strong></div>
        <div class="small">Username: <strong id="pUsername"></strong></div>
        <div class="small">Telegram ID: <strong id="pId"></strong></div>
        <div class="small" style="margin-top:8px">Ads today: <strong id="pAds">0</strong>/20</div>
        <div style="margin-top:8px">
          <button class="btn" onclick="shareReferral()">Share Referral</button>
        </div>
      </div>

    </div>

    <div class="nav">
      <button class="btn ghost" onclick="showSection('home')">Home</button>
      <button class="btn ghost" onclick="showSection('leaderboard')">Leaderboard</button>
      <button class="btn ghost" onclick="showSection('wallet')">Wallet</button>
      <button class="btn ghost" onclick="showSection('profile')">Profile</button>
    </div>
  </div>

<script>
/* -------------- CONFIG -------------- */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDCcKpU-6lPnjn7NSTZVq6R5HGLac2GlAk",
  authDomain: "zaroratpay.firebaseapp.com",
  databaseURL: "https://zaroratpay-default-rtdb.firebaseio.com",
  projectId: "zaroratpay",
  storageBucket: "zaroratpay.firebasestorage.app",
  messagingSenderId: "992212281257",
  appId: "1:992212281257:web:bf5e442cc2636725ee06b8"
};
const AD_REWARD = 0.15;
const DAILY_LIMIT = 20;
const REFERRAL_REWARD = 2.0;

/* -------------- INIT Firebase -------------- */
firebase.initializeApp(FIREBASE_CONFIG);
const rdb = firebase.database();

/* -------------- Telegram Init -------------- */
let tg = null;
try { tg = window.Telegram.WebApp; tg.expand(); } catch(e){ tg = null; }
const tgUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
const uid = tgUser ? String(tgUser.id) : ('guest_' + Math.random().toString(36).slice(2,9));
let state = { balance:0, ads_today:0, ads_date:'' };

/* -------------- Utils -------------- */
function todayISO(){ const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function fmt(n){ return Number(n||0).toFixed(2); }
function showSection(id){
  const sections=['home','wallet','topup','leaderboard','profile'];
  sections.forEach(s => document.getElementById(s).classList.toggle('hidden', s!==id));
  if(id==='wallet') loadTransactions();
  if(id==='leaderboard') loadLeaderboard();
  if(id==='profile') renderProfile();
}

/* -------------- App start -------------- */
function enterApp(){
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  initApp();
}

window.addEventListener('load', ()=> {
  // if you want auto-enter when inside Telegram uncomment:
  // if(tg && tgUser) enterApp();
});

/* -------------- Initialization & Listeners -------------- */
function initApp(){
  // show profile info
  if(tgUser){
    document.getElementById('profilePhoto').src = tgUser.photo_url || 'https://via.placeholder.com/100';
    document.getElementById('profileName').innerText = tgUser.first_name || 'User';
    document.getElementById('profileUsername').innerText = tgUser.username ? '@'+tgUser.username : '';
    document.getElementById('pName').innerText = (tgUser.first_name||'') + ' ' + (tgUser.last_name||'');
    document.getElementById('pUsername').innerText = tgUser.username || '';
    document.getElementById('pId').innerText = uid;
  } else {
    document.getElementById('profileName').innerText = 'Guest';
  }

  // ensure user record
  const uRef = rdb.ref('users/' + uid);
  uRef.once('value').then(snap => {
    const now = todayISO();
    if(!snap.exists()){
      uRef.set({
        id: uid,
        first_name: tgUser ? tgUser.first_name : 'Guest',
        username: tgUser ? tgUser.username : '',
        photo: tgUser ? tgUser.photo_url : '',
        balance: 0,
        ads_today: 0,
        ads_date: now,
        referrals: 0,
        joinedAt: Date.now(),
        lastLogin: Date.now()
      });
      state = { balance:0, ads_today:0, ads_date: now };
      updateUI();
    } else {
      const data = snap.val();
      if(!data.ads_date || data.ads_date !== now){
        uRef.update({ ads_today:0, ads_date: now });
        data.ads_today = 0; data.ads_date = now;
      }
      state.balance = Number(data.balance || 0);
      state.ads_today = Number(data.ads_today || 0);
      state.ads_date = data.ads_date || now;
      updateUI();
    }
    // daily bonus
    dailyBonusCheck();
  });

  // listen for live changes
  rdb.ref('users/' + uid).on('value', snap => {
    const d = snap.val() || {};
    state.balance = Number(d.balance || 0);
    state.ads_today = Number(d.ads_today || 0);
    state.ads_date = d.ads_date || todayISO();
    updateUI();
  });

  // ad button
  document.getElementById('watchAdBtn').addEventListener('click', ()=> playRewardedAd());

  // referral share button in profile
  // shareReferral called by UI btn
}

/* -------------- UI updates -------------- */
function updateUI(){
  document.getElementById('balance').innerText = fmt(state.balance);
  document.getElementById('walletBalance').innerText = fmt(state.balance);
  document.getElementById('adsInfo').innerText = `Ads today: ${state.ads_today}/${DAILY_LIMIT}`;
  const adsTodayEl = document.getElementById('adsToday');
  if(adsTodayEl) adsTodayEl.innerText = `Ads today: ${state.ads_today}/${DAILY_LIMIT}`;
  document.getElementById('pAds').innerText = state.ads_today;
}

/* -------------- Atomic reward grant -------------- */
function grantRewardAtomic(reward=AD_REWARD){
  const uRef = rdb.ref('users/' + uid);
  return uRef.transaction(u => {
    if(!u) return u;
    const curDay = todayISO();
    if(!u.ads_date || u.ads_date !== curDay){
      u.ads_date = curDay;
      u.ads_today = 0;
    }
    if((u.ads_today||0) >= DAILY_LIMIT){
      return u; // no change
    }
    u.ads_today = (u.ads_today||0) + 1;
    u.balance = Number(((u.balance||0) + Number(reward)).toFixed(6));
    return u;
  }, (err, committed, snap) => {
    if(err){ console.error(err); alert('Error processing reward.'); return; }
    if(!committed){ alert(`You reached daily limit (${DAILY_LIMIT}) of ads.`); return; }
    // record tx
    const txRef = rdb.ref('transactions').push();
    txRef.set({ id: txRef.key, uid, type: 'reward', amount: reward, timestamp: Date.now() });
  });
}

/* -------------- Ad SDK detection and play -------------- */
function findAdFn(){
  // explicit known name often created by script tag data-sdk attr:
  if(typeof window.show_10088330 === 'function') return window.show_10088330;
  if(typeof window.show_3068852 === 'function') return window.show_3068852;
  if(typeof window.show_10016982 === 'function') return window.show_10016982;
  // generic search
  for(const k in window){
    if(typeof k === 'string' && k.startsWith('show_') && typeof window[k] === 'function'){
      return window[k];
    }
  }
  return null;
}

async function playRewardedAd(){
  if(!tg){
    alert('Open this Mini App inside Telegram to earn rewards.');
    return;
  }
  // quick local limit check
  if(state.ads_today >= DAILY_LIMIT){ alert(`Daily limit ${DAILY_LIMIT} reached.`); return; }

  const adFn = findAdFn();
  if(!adFn){
    alert('Ad SDK not loaded or zone ID incorrect. Check console.');
    console.warn('No ad fn found on window.'); return;
  }

  try {
    // try call patterns
    let res;
    try { res = adFn('pop'); } catch(e1) {
      try { res = adFn({type:'rewarded'}); } catch(e2) {
        try { res = adFn(); } catch(e3) { res = undefined; }
      }
    }

    if(res && typeof res.then === 'function'){
      await res; // wait for promise resolution
      await grantRewardAtomic(AD_REWARD);
      alert(`âœ… You earned ${AD_REWARD} AFN`);
      return;
    }

    // fallback: set common global callback listeners
    let rewarded = false;
    const cbNames = ['onAdComplete','onReward','on_ad_complete','onRewarded','onAdClosed'];
    const originals = {};
    cbNames.forEach(n => { originals[n] = window[n]; window[n] = function(){ rewarded = true; grantRewardAtomic(AD_REWARD); window[n] = originals[n]; }; });

    // wait a short time for SDK to call callback
    await new Promise(r => setTimeout(r, 7000));
    if(rewarded){ alert(`âœ… You earned ${AD_REWARD} AFN`); return; }

    // ask user confirm
    const ok = confirm('If you watched the full ad, press OK to get reward.');
    if(ok){ await grantRewardAtomic(AD_REWARD); alert(`âœ… You earned ${AD_REWARD} AFN`); }
    else alert('No reward given.');

  } catch(err){
    console.error('Ad play error', err);
    alert('Ad failed: see console.');
  }
}

/* -------------- Referral handling -------------- */
function handleReferralOnOpen(){
  const params = new URLSearchParams(window.location.search);
  const refId = params.get('start') || params.get('ref');
  if(refId && refId !== uid){
    const logKey = `referrals_claimed/${uid}`;
    rdb.ref(logKey).once('value').then(snap=>{
      if(snap.exists()){ return; } // already credited
      // credit referrer via transaction
      const refUserRef = rdb.ref('users/' + refId);
      refUserRef.transaction(u =>{
        if(!u) return u;
        u.balance = Number(((u.balance||0) + REFERRAL_REWARD).toFixed(6));
        u.referrals = (u.referrals||0) + 1;
        return u;
      }, (err, committed) =>{
        if(err) console.error('ref tx err',err);
        if(committed){
          rdb.ref(logKey).set({ refId, ts: Date.now() });
          const txRef = rdb.ref('transactions').push();
          txRef.set({ id: txRef.key, uid: refId, type:'referral', amount: REFERRAL_REWARD, from: uid, timestamp: Date.now() });
          console.log('Referral credited to', refId);
        }
      });
    });
  }
}

/* -------------- Daily Bonus -------------- */
function dailyBonusCheck(){
  const uRef = rdb.ref('users/' + uid);
  uRef.once('value').then(snap=>{
    const data = snap.val() || {};
    const lastLogin = data.lastLogin || 0;
    const todayStart = new Date().setHours(0,0,0,0);
    if(!lastLogin || lastLogin < todayStart){
      uRef.transaction(u => {
        if(!u) return u;
        u.balance = Number(((u.balance||0) + 1).toFixed(6));
        u.lastLogin = Date.now();
        return u;
      }, (err, committed) => { if(committed) alert('ðŸŽ Daily Bonus: 1 AFN added!'); });
    }
  });
}

/* -------------- Top-up & Withdraw & Transactions -------------- */
function loadTransactions(){
  const el = document.getElementById('txList');
  el.innerHTML = 'Loading...';
  rdb.ref('transactions').orderByChild('uid').equalTo(uid).limitToLast(50).once('value').then(snap=>{
    const arr=[]; snap.forEach(ch=> arr.push(ch.val()));
    arr.sort((a,b)=> b.timestamp - a.timestamp);
    if(arr.length===0){ el.innerHTML = '<div class="small">No transactions yet.</div>'; return; }
    el.innerHTML = arr.map(t => `<div class="tx-item"><strong>${t.type}</strong> â€” ${fmt(t.amount||0)} AFN<div class="small">${new Date(t.timestamp).toLocaleString()}</div></div>`).join('');
  }).catch(e=> { el.innerHTML = 'Error loading'; console.error(e); });
}

function doTopup(){
  if(!tg){ alert('Open inside Telegram to top-up.'); return; }
  const phone = document.getElementById('phone').value.trim();
  const op = document.getElementById('operator').value;
  const amt = Number(document.getElementById('topupAmount').value || 0);
  const status = document.getElementById('topupStatus');
  status.innerText = '';
  if(!phone || phone.length < 7){ status.innerText = 'Enter valid phone.'; return; }
  if(amt < 25){ status.innerText = 'Top-up must be at least 25 AFN.'; return; }
  const balRef = rdb.ref('users/' + uid + '/balance');
  balRef.transaction(cur => { if((cur||0) < amt) return; return (cur||0) - amt; }, (err, committed, snap) => {
    if(err){ status.innerText = 'Error processing top-up.'; console.error(err); return; }
    if(!committed){ status.innerText = 'Insufficient balance.'; return; }
    const txRef = rdb.ref('transactions').push();
    const tx = { id: txRef.key, uid, type:'topup', operator:op, phone, amount:amt, timestamp: Date.now(), status:'success' };
    txRef.set(tx);
    rdb.ref('topups').push(tx);
    status.innerText = `Top-up successful: ${fmt(amt)} AFN â†’ ${phone} (${op})`;
    loadTransactions();
    loadBalanceOnce();
  });
}

function requestWithdraw(){
  if(!tg){ alert('Open inside Telegram to withdraw.'); return; }
  const to = document.getElementById('withdrawTo').value.trim();
  const amt = Number(document.getElementById('withdrawAmount').value || 0);
  const status = document.getElementById('withdrawStatus');
  status.innerText = '';
  if(!to || to.length < 5){ status.innerText = 'Enter destination.'; return; }
  if(amt <= 0){ status.innerText = 'Enter amount.'; return; }
  const balRef = rdb.ref('users/' + uid + '/balance');
  balRef.transaction(cur => { if((cur||0) < amt) return; return (cur||0) - amt; }, (err, committed) => {
    if(err){ status.innerText = 'Error.'; console.error(err); return; }
    if(!committed){ status.innerText = 'Insufficient balance.'; return; }
    const wRef = rdb.ref('withdraws').push();
    const wobj = { id: wRef.key, uid, to, amount: amt, status: 'pending', timestamp: Date.now() };
    wRef.set(wobj);
    const txRef = rdb.ref('transactions').push();
    txRef.set({ id: txRef.key, uid, type:'withdraw_request', amount: amt, timestamp: Date.now() });
    status.innerText = 'Withdraw requested (pending).';
    loadTransactions(); loadBalanceOnce();
  });
}

function loadBalanceOnce(){ rdb.ref('users/'+uid+'/balance').once('value').then(s=>{ state.balance = Number(s.exists()?s.val():0); updateUI(); }); }

/* -------------- Leaderboard -------------- */
function loadLeaderboard(){
  const el = document.getElementById('leaderboardList');
  el.innerHTML = 'Loading...';
  rdb.ref('users').orderByChild('balance').limitToLast(10).once('value').then(snap=>{
    const arr=[]; snap.forEach(ch=> arr.push(ch.val()));
    arr.sort((a,b)=> (b.balance||0) - (a.balance||0));
    if(arr.length===0){ el.innerHTML = '<div class="small">No users yet.</div>'; return; }
    el.innerHTML = arr.map((u,i)=>`<div style="padding:8px 0;border-bottom:1px solid #f4f6f8"><strong>#${i+1} ${u.first_name||u.name||'User'}</strong> â€” ${fmt(u.balance||0)} AFN</div>`).join('');
  }).catch(e=> el.innerHTML='Error', console.error(e));
}

/* -------------- Profile render & share referral -------------- */
function renderProfile(){
  document.getElementById('pName').innerText = tgUser ? (tgUser.first_name||'') + ' ' + (tgUser.last_name||'') : 'Guest';
  document.getElementById('pUsername').innerText = tgUser ? (tgUser.username||'') : '';
  document.getElementById('pId').innerText = uid;
  document.getElementById('pAds').innerText = state.ads_today || 0;
}

function shareReferral(){
  if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user){ alert('Open inside Telegram to share referral'); return; }
  const myId = String(tg.initDataUnsafe.user.id);
  const botUsername = 'TimuriAppBot'; // <-- REPLACE with your real bot username if different
  const refLink = `https://t.me/${botUsername}?start=${myId}`;
  try { tg.shareUrl(refLink); } catch(e){ alert('Share link: ' + refLink); }
}

/* -------------- Handle referral on open -------------- */
function handleReferral(){
  // call on app init
  handleReferralOnOpen();
}

/* -------------- Expose some helpers for debugging -------------- */
window._timuri = { grantRewardAtomic, playRewardedAd, doTopup, requestWithdraw, loadLeaderboard, shareReferral };

/* -------------- run referral handler when loaded -------------- */
handleReferral();

</script>
</body>
</html>
