<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZaroratPay — Telegram Mini App</title>
<!-- Basic styles (mobile-first) -->
<style>
  :root{
    --primary:#0088cc;
    --primary-dark:#006699;
    --bg:#f0f4f7;
    --card:#fff;
    --radius:14px;
    --maxw:420px;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;display:flex;align-items:flex-start;justify-content:center;padding:18px 12px 40px;}
  .app{width:100%;max-width:var(--maxw);}
  .center{display:flex;align-items:center;justify-content:center}
  .splash{height:80vh;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;background:var(--primary);border-radius:16px;padding:24px;text-align:center;}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,0.08);margin-bottom:12px;}
  img.profile{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
  h1,h2,h3{margin:8px 0}
  .menu{display:flex;flex-wrap:wrap;gap:8px}
  .btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,136,204,0.12)}
  .row{display:flex;gap:8px;align-items:center}
  .field{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd}
  .leader-item{display:flex;justify-content:space-between;padding:8px 4px;border-bottom:1px solid #f0f0f0}
  .small{font-size:13px;color:#666}
  nav.bottom{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:transparent;width:100%;max-width:var(--maxw);display:flex;justify-content:space-around;padding:0 8px}
  nav.bottom button{flex:1;margin:0 6px}
  .hidden{display:none}
  .note{font-size:13px;color:#444}
  .warning{color:#8a2b2b;background:#fff0f0;padding:8px;border-radius:8px}
</style>
</head>
<body>
  <div class="app">

    <!-- SPLASH -->
    <div id="splash" class="splash card">
      <img src="" id="splashPhoto" class="profile" style="width:96px;height:96px;border-radius:50%;margin-bottom:12px" />
      <h1 id="splashName">ZaroratPay</h1>
      <p class="small" id="splashSub">Loading... please open from Telegram to auto-login</p>
      <div style="margin-top:12px">
        <button class="btn" onclick="goHome()">Enter App</button>
      </div>
      <p class="small" style="margin-top:10px">If not opened inside Telegram — user data won't be available.</p>
    </div>

    <!-- APP MAIN -->
    <div id="appMain" class="hidden">

      <!-- PROFILE CARD -->
      <div class="card" id="profileCard">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="profilePhoto" class="profile" src="https://via.placeholder.com/100" alt="photo" />
          <div style="flex:1">
            <h2 id="profileName">Hello</h2>
            <div class="small" id="profileUsername">@username</div>
            <div class="small" id="profileId" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <!-- HOME -->
      <div id="home" class="card">
        <h3>Home</h3>
        <p class="note">Balance: <strong id="balance">0</strong> AFN</p>
        <div class="menu" style="margin-top:10px">
          <button class="btn" onclick="showSection('leaderboard')">Leaderboard</button>
          <button class="btn" onclick="showSection('deposit')">Deposit / Wallet</button>
          <button class="btn ghost" onclick="showSection('profile')">Profile</button>
          <button class="btn ghost" onclick="showSection('settings')">Settings</button>
        </div>
      </div>

      <!-- LEADERBOARD -->
      <div id="leaderboard" class="card hidden">
        <h3>Leaderboard</h3>
        <div id="leaderList" style="margin-top:8px"></div>
      </div>

      <!-- DEPOSIT / WALLET -->
      <div id="deposit" class="card hidden">
        <h3>Deposit / Wallet</h3>
        <p class="small">Add a demo balance to your wallet. (For production integrate payment gateway)</p>
        <div style="margin-top:8px" class="row">
          <input id="depositAmount" class="field" type="number" placeholder="Amount (AFN)" />
          <button class="btn" onclick="doDeposit()">Add</button>
        </div>
        <div style="margin-top:10px" id="txStatus" class="small"></div>

        <hr style="margin:12px 0"/>
        <h4>Transactions</h4>
        <div id="txList" class="small"></div>
      </div>

      <!-- PROFILE PAGE -->
      <div id="profile" class="card hidden">
        <h3>Profile</h3>
        <p id="profileInfo" class="small"></p>
        <button class="btn" onclick="openTelegramChat()">Open Chat with Bot</button>
      </div>

      <!-- SETTINGS -->
      <div id="settings" class="card hidden">
        <h3>Settings</h3>
        <p class="small">App demo settings.</p>
        <div style="margin-top:8px">
          <label class="small">Theme</label>
          <div style="margin-top:6px" class="row">
            <button class="btn ghost" onclick="alert('Theme set demo')">Light</button>
            <button class="btn" onclick="alert('Theme set demo')">Dark</button>
          </div>
        </div>
        <div style="margin-top:10px" class="warning">For production enable server-side validation of Telegram initData and secure payment flow.</div>
      </div>

    </div>

    <!-- bottom nav -->
    <nav class="bottom">
      <button class="btn ghost" onclick="showSection('home')">Home</button>
      <button class="btn ghost" onclick="showSection('leaderboard')">Leaderboard</button>
      <button class="btn ghost" onclick="showSection('deposit')">Deposit</button>
      <button class="btn ghost" onclick="showSection('profile')">Profile</button>
      <button class="btn ghost" onclick="showSection('settings')">Settings</button>
    </nav>

  </div>

<!-- Firebase JS (compat) and Telegram WebApp -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script async src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
/* ============================
   Config: use your provided Firebase config
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDCcKpU-6lPnjn7NSTZVq6R5HGLac2GlAk",
  authDomain: "zaroratpay.firebaseapp.com",
  databaseURL: "https://zaroratpay-default-rtdb.firebaseio.com",
  projectId: "zaroratpay",
  storageBucket: "zaroratpay.firebasestorage.app",
  messagingSenderId: "992212281257",
  appId: "1:992212281257:web:bf5e442cc2636725ee06b8",
  measurementId: "G-51VT4W8MYZ"
};
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

/* ============================
   App State & Helpers
   ============================ */
let tg = null;
let currentUser = null; // Telegram user object (from initDataUnsafe.user)
let myUid = null;

function showSection(id){
  // show appMain and hide other sections except profileCard
  document.getElementById('appMain').classList.remove('hidden');
  const sections = ['home','leaderboard','deposit','profile','settings'];
  sections.forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
  if(id === 'leaderboard') loadLeaderboard();
  if(id === 'deposit') loadTransactions();
  if(id === 'profile') renderProfile();
}

/* ============================
   Telegram Init & App start
   ============================ */
function initTelegram(){
  try{
    tg = window.Telegram.WebApp;
  }catch(e){
    tg = null;
  }

  // When opened INSIDE Telegram, tg.initDataUnsafe.user will exist
  if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    currentUser = tg.initDataUnsafe.user;
    myUid = String(currentUser.id);
    // show profile in splash then auto-enter
    document.getElementById('splashPhoto').src = currentUser.photo_url || 'https://via.placeholder.com/100';
    document.getElementById('splashName').innerText = `Welcome, ${currentUser.first_name || 'User'}`;
    document.getElementById('splashSub').innerText = `Logged in as ${currentUser.username ? '@'+currentUser.username : 'Telegram user'}`;

    // Save to Firebase (if not exists)
    const uRef = rdb.ref('users/'+myUid);
    uRef.once('value').then(snap => {
      if(!snap.exists()){
        uRef.set({
          id: myUid,
          first_name: currentUser.first_name || '',
          last_name: currentUser.last_name || '',
          username: currentUser.username || '',
          photo: currentUser.photo_url || '',
          balance: 0,
          joinedAt: Date.now()
        });
      } else {
        // merge photo/username in case changed
        uRef.update({
          first_name: currentUser.first_name || '',
          last_name: currentUser.last_name || '',
          username: currentUser.username || '',
          photo: currentUser.photo_url || ''
        });
      }
    });

    // small delay then enter
    setTimeout(() => {
      goHome();
    }, 1100);

  } else {
    // Not opened inside Telegram
    document.getElementById('splashPhoto').src = 'https://via.placeholder.com/96';
    document.getElementById('splashName').innerText = `ZaroratPay`;
    document.getElementById('splashSub').innerText = `Open this Mini App from Telegram to auto-login.`;
    // Let user optionally still continue to demo UI by clicking Enter
  }
}

/* ============================
   Go Home / render
   ============================ */
function goHome(){
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('appMain').classList.remove('hidden');
  // render profile card if user available
  if(currentUser){
    document.getElementById('profilePhoto').src = currentUser.photo_url || 'https://via.placeholder.com/100';
    document.getElementById('profileName').innerText = `${currentUser.first_name || 'User'}`;
    document.getElementById('profileUsername').innerText = currentUser.username ? '@'+currentUser.username : '';
    document.getElementById('profileId').innerText = `ID: ${currentUser.id}`;
    // load balance
    rdb.ref('users/'+myUid+'/balance').on('value', snap => {
      const b = snap.exists() ? snap.val() : 0;
      document.getElementById('balance').innerText = b;
    });
  } else {
    // demo values
    document.getElementById('profilePhoto').src = 'https://via.placeholder.com/100';
    document.getElementById('profileName').innerText = `Guest`;
    document.getElementById('profileUsername').innerText = '';
    document.getElementById('profileId').innerText = '';
    document.getElementById('balance').innerText = '0';
  }
  showSection('home');
}

/* ============================
   Leaderboard: load top users by balance
   ============================ */
function loadLeaderboard(){
  const listEl = document.getElementById('leaderList');
  listEl.innerHTML = '<div class="small">Loading...</div>';
  // query top 20 by balance (Realtime DB - uses orderByChild)
  rdb.ref('users').orderByChild('balance').limitToLast(20).once('value').then(snap => {
    const arr = [];
    snap.forEach(child => {
      arr.push(child.val());
    });
    // since limitToLast returns ascending, reverse for descending
    arr.sort((a,b)=> (b.balance||0)-(a.balance||0));
    if(arr.length===0){
      listEl.innerHTML = '<div class="small">No users yet.</div>';
      return;
    }
    listEl.innerHTML = arr.map((u, idx) => `
      <div class="leader-item">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="width:36px;text-align:center">${idx+1}</div>
          <div>
            <div style="font-weight:600">${u.first_name||'User'} ${u.username?'<span class="small">('+u.username+')' : ''}</div>
            <div class="small">${u.joinedAt ? new Date(u.joinedAt).toLocaleDateString() : ''}</div>
          </div>
        </div>
        <div style="font-weight:700">${u.balance||0}</div>
      </div>
    `).join('');
  }).catch(err=>{
    listEl.innerHTML = `<div class="small">Error loading leaderboard.</div>`;
    console.error(err);
  });
}

/* ============================
   Deposit: demo add money & transactions
   ============================ */
function doDeposit(){
  const amt = Number(document.getElementById('depositAmount').value || 0);
  if(!currentUser){
    alert('You must open the app inside Telegram to deposit.');
    return;
  }
  if(!(amt>0)){
    alert('Enter a valid amount.');
    return;
  }
  const txRef = rdb.ref('transactions').push();
  const tx = {
    id: txRef.key,
    uid: myUid,
    amount: amt,
    type: 'deposit',
    timestamp: Date.now()
  };
  txRef.set(tx).then(()=>{
    // update user balance atomically using transaction
    const uBalRef = rdb.ref('users/'+myUid+'/balance');
    uBalRef.transaction(current => {
      return (current||0) + amt;
    }).then(() => {
      document.getElementById('txStatus').innerText = `Added ${amt} AFN to your wallet.`;
      document.getElementById('depositAmount').value = '';
      loadTransactions();
    }).catch(e=>{
      document.getElementById('txStatus').innerText = `Error updating balance.`;
      console.error(e);
    });
  }).catch(e=>{
    document.getElementById('txStatus').innerText = `Transaction failed.`;
    console.error(e);
  });
}

function loadTransactions(){
  const txList = document.getElementById('txList');
  if(!currentUser) { txList.innerHTML = '<div class="small">No transactions (guest)</div>'; return; }
  rdb.ref('transactions').orderByChild('uid').equalTo(myUid).limitToLast(50).once('value').then(snap=>{
    const arr = [];
    snap.forEach(ch => arr.push(ch.val()));
    arr.sort((a,b)=> b.timestamp - a.timestamp);
    if(arr.length===0){ txList.innerHTML = '<div class="small">No transactions yet.</div>'; return; }
    txList.innerHTML = arr.map(tx=>`<div style="padding:6px 0;border-bottom:1px solid #f4f4f4">
      <div><strong>${tx.type}</strong> — ${tx.amount} AFN</div>
      <div class="small">${new Date(tx.timestamp).toLocaleString()}</div>
    </div>`).join('');
  });
}

/* ============================
   Profile render & Open Chat
   ============================ */
function renderProfile(){
  const info = document.getElementById('profileInfo');
  if(!currentUser){ info.innerText = 'Guest view (open inside Telegram to see your profile).'; return; }
  info.innerHTML = `
    Name: <strong>${currentUser.first_name || ''} ${currentUser.last_name || ''}</strong><br/>
    Username: <strong>${currentUser.username || ''}</strong><br/>
    Telegram ID: <strong>${currentUser.id}</strong>
  `;
}

function openTelegramChat(){
  if(!tg) return alert('Open app inside Telegram to launch chat.');
  // try to open bot chat (bot username must be known)
  // Replace 'zaroratpay_bot' with your real bot username when deploying
  const botUsername = 'zaroratpay_bot';
  tg.openTelegramLink(`https://t.me/${botUsername}`);
}

/* ============================
   Init on load
   ============================ */
window.addEventListener('load', ()=>{
  initTelegram();
});
</script>
</body>
</html>
