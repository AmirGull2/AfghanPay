<!doctype html>
<html lang="ps">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Timuri â€” Real Rewarded Ads</title>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Monetag / LibTL SDK (replace ZONE_ID if needed) -->
<!-- IMPORTANT: Replace ZONE_ID below with your actual Monetag zone id -->
<script>
  const ZONE_ID = '10102842'; // <<< CHANGE THIS if your zone id differs
  (function(){
    const s = document.createElement('script');
    s.src = `//libtl.com/sdk.js`;
    s.setAttribute('data-zone', 10102842);
    s.setAttribute('data-sdk', `show_${10102842}`);
    s.async = true;
    document.head.appendChild(s);
  })();
</script>

<style>
  :root{--card:#0b1220;--accent:#00c853}
  body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(180deg,#071428,#0b1220);color:#fff;display:flex;justify-content:center;align-items:flex-start;padding:28px 12px;min-height:100vh}
  .app{width:100%;max-width:420px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  h1{font-size:20px;margin:0 0 8px}
  .profile{display:flex;gap:12px;align-items:center}
  .avatar{width:66px;height:66px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .meta{flex:1;text-align:left}
  .balance{margin-top:12px;background:rgba(255,255,255,0.03);padding:10px;border-radius:10px;font-weight:600}
  .btn{width:100%;padding:14px;border-radius:12px;border:0;margin-top:12px;font-weight:700;background:var(--accent);color:#001;cursor:pointer}
  .muted{color:#aeb8c6;font-size:13px;margin-top:8px}
  .small{font-size:13px;color:#cbd5e1}
  .danger{background:#ff6b6b;color:#fff}
  .row{display:flex;gap:8px}
  footer{margin-top:14px;font-size:12px;color:#94a3b8;text-align:center}
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>ğŸ¬ Timuri â€” Real Rewarded Video</h1>

      <div id="profileArea" class="profile">
        <img id="avatar" class="avatar" src="https://i.ibb.co/fxLwLrR/user.png" alt="avatar">
        <div class="meta">
          <div id="username" class="small">Telegram login required</div>
          <div id="userid" class="small muted"></div>
        </div>
      </div>

      <div id="balanceBox" class="balance">ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÙŠ: <span id="balance">0.00</span> AFN</div>

      <button id="watchBtn" class="btn">â–¶ï¸ ÙˆÛŒÚ‰ÛŒÙˆ ÙˆÚ«ÙˆØ±Ù‡ â€” 0.15 AFN</button>
      <div id="status" class="muted small">Ø­Ø§Ù„Øª: ØªÛŒØ§Ø±</div>
      <div class="muted small">â€¢ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø­Ø¯: <span id="limit">20</span> ÙˆÛŒÚ‰ÛŒÙˆ/ÙˆØ±Ú</div>

      <div style="margin-top:12px" class="row">
        <button id="shareBtn" class="btn" style="flex:1;background:#60a5fa;color:#012">Ø´Ø±ÛŒÚ©ÙˆÙ„</button>
        <button id="txBtn" class="btn" style="flex:1;background:#94a3b8;color:#001">ØªØ±Ø§Ú©Ù†Ø´ÙˆÙ†Ù‡</button>
      </div>

      <div id="txList" style="margin-top:12px;display:none"></div>

      <footer>Timuri â€¢ Powered by Monetag & Firebase</footer>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const ZONE_ID = window.ZONE_ID || '10102842'; // ensure same as script
const SHOW_FN_NAME = `show_${10102842}`;      // typical global fn name created by SDK
const REWARD_AMOUNT = 0.15;                  // AFN per completed video
const DAILY_LIMIT = 20;                      // per-user daily cap

/* Firebase config (user provided) */
const firebaseConfig = {
  apiKey: "AIzaSyDCcKpU-6lPnjn7NSTZVq6R5HGLac2GlAk",
  authDomain: "zaroratpay.firebaseapp.com",
  databaseURL: "https://zaroratpay-default-rtdb.firebaseio.com",
  projectId: "zaroratpay",
  storageBucket: "zaroratpay.firebasestorage.app",
  messagingSenderId: "992212281257",
  appId: "1:992212281257:web:bf5e442cc2636725ee06b8",
  measurementId: "G-51VT4W8MYZ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Telegram WebApp */
let tg = null;
try { tg = window.Telegram.WebApp; tg.expand(); } catch(e){ tg = null; }

/* local state */
let telegramUser = null;
let uid = null;
let dailyKey = null;

/* UI elements */
const avatarEl = document.getElementById('avatar');
const usernameEl = document.getElementById('username');
const useridEl = document.getElementById('userid');
const balanceEl = document.getElementById('balance');
const watchBtn = document.getElementById('watchBtn');
const statusEl = document.getElementById('status');
const txBtn = document.getElementById('txBtn');
const txList = document.getElementById('txList');
const shareBtn = document.getElementById('shareBtn');
const limitEl = document.getElementById('limit');
limitEl.innerText = DAILY_LIMIT;

/* ----------------- Helpers ----------------- */

function log(...args){ console.log('[Timuri]', ...args); }
function setStatus(s){ statusEl.innerText = 'Ø­Ø§Ù„Øª: ' + s; }

/* get ad function if available */
function findAdFunction(){
  if(window[SHOW_FN_NAME] && typeof window[SHOW_FN_NAME] === 'function') return window[SHOW_FN_NAME];
  // search generic show_*
  for(const k in window){
    if(k.startsWith && typeof k === 'string' && k.startsWith('show_') && typeof window[k] === 'function'){
      log('Using ad function:', k);
      return window[k];
    }
  }
  return null;
}

/* atomic reward transaction on Firebase */
function grantRewardAtomic(userId, amount){
  const userRef = db.ref('users/' + userId);
  const today = new Date(); const dayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  return userRef.transaction(u=>{
    if(!u){
      // initialize
      u = { balance: 0, ads_today: 0, ads_date: dayKey, name: telegramUser?.first_name || 'User' };
    }
    // reset daily if needed
    if(!u.ads_date || u.ads_date !== dayKey){
      u.ads_date = dayKey;
      u.ads_today = 0;
    }
    if((u.ads_today || 0) >= DAILY_LIMIT){
      // reach limit: abort transaction by returning undefined (no change)
      return;
    }
    u.ads_today = (u.ads_today || 0) + 1;
    u.balance = Number(((u.balance || 0) + amount).toFixed(6));
    // also increase total earned
    u.total_earned = Number(((u.total_earned || 0) + amount).toFixed(6));
    return u;
  }, (err, committed, snap)=>{
    if(err){
      log('Transaction error', err);
      setStatus('Transaction error');
      return;
    }
    if(!committed){
      // not committed = likely daily limit reached
      setStatus('Ø¯ ÙˆØ±ÚÙŠ Ø­Ø¯ Ù¾ÙˆØ±Ù‡ Ø´Ùˆ');
      alert('ØªØ§Ø³Ùˆ Ø¯ Ù†Ù† ÙˆØ±ÚÛ Ø­Ø¯ ØªÙ‡ ÙˆØ±Ø³ÛØ¯Ø¦.');
      return;
    }
    // record transaction
    const txRef = db.ref('transactions').push();
    const tx = {
      uid: userId,
      type: 'reward',
      amount: amount,
      zone: ZONE_ID,
      timestamp: Date.now()
    };
    txRef.set(tx);
    setStatus('Reward Ø«Ø¨Øª Ø´Ùˆ');
    log('Reward granted and tx recorded', tx);
  });
}

/* increment impression count (for analytics) */
function recordImpression(zone=ZONE_ID){
  const statsRef = db.ref('stats/impressions/' + zone);
  statsRef.transaction(v => (v || 0) + 1);
}

/* load UI balance & daily count */
function startUserSync(userId){
  const uRef = db.ref('users/' + userId);
  uRef.on('value', snap=>{
    const data = snap.val() || {};
    balanceEl.innerText = (data.balance || 0).toFixed(2);
    // update UI limit text
    setStatus(`Ø§Ø¹Ù„Ø§Ù†ÙˆÙ†Ù‡ Ù†Ù†: ${ (data.ads_today || 0) }`);
  });
  // load last 20 txs
  db.ref('transactions').orderByChild('uid').equalTo(userId).limitToLast(20).once('value').then(snap=>{
    const arr = []; snap.forEach(c=>arr.push(c.val()));
    if(arr.length===0) txList.innerHTML = '<div class="small muted">No transactions yet.</div>';
    else txList.innerHTML = arr.reverse().map(t => `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">${new Date(t.timestamp).toLocaleString()} â€” ${t.type} â€” ${t.amount} AFN</div>`).join('');
  });
}

/* prevent rapid repeated claim attempts */
let lastAdStart = 0;

/* ----------------- App Init ----------------- */

function initFromTelegram(){
  try{
    if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
      telegramUser = tg.initDataUnsafe.user;
      uid = String(telegramUser.id);
      avatarEl.src = telegramUser.photo_url || avatarEl.src;
      usernameEl.innerText = (telegramUser.first_name || 'User') + (telegramUser.username ? (' @' + telegramUser.username) : '');
      useridEl.innerText = 'Telegram ID: ' + uid;
      setStatus('Logged in as Telegram user');
      startUserSync(uid);
      // handle referral param if any
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('start') || params.get('ref');
      if(ref && ref !== uid){
        // credit referrer one-time
        const claimRef = db.ref(`ref_claims/${uid}`);
        claimRef.once('value').then(s=>{
          if(s.exists()) return;
          // credit ref
          const refUserRef = db.ref('users/' + ref);
          refUserRef.transaction(u => {
            if(!u) return u;
            u.balance = Number(((u.balance||0) + (2)).toFixed(6));
            u.referrals = (u.referrals||0) + 1;
            return u;
          }, (err, committed)=> { if(committed){ db.ref('transactions').push({ uid: ref, type:'referral', amount:2, from: uid, timestamp:Date.now() }); claimRef.set(true); }});
        });
      }
    } else {
      setStatus('Open from Telegram to login');
    }
  }catch(e){ console.error(e); setStatus('Telegram init error'); }
}

/* ----------------- Ad flow ----------------- */

async function playRewarded(){
  if(!uid){ alert('Ù„Ø·ÙØ§Ù‹ Ø¯ Telegram Ù„Ù‡ Ù„Ø§Ø±Û Ù†Ù†ÙˆØ²Ø¦.'); return; }
  // daily check quick local - also handled on server via transaction
  const uSnap = await db.ref('users/' + uid).once('value');
  const u = uSnap.val() || {};
  const today = new Date(); const dayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  if(u.ads_date !== dayKey && u.ads_today) { /* ignore: will be fixed by transaction */ }
  if((u.ads_today || 0) >= DAILY_LIMIT){ alert('Ø¯ Ù†Ù† ÙˆØ±ÚÛ Ø­Ø¯ Ù¾ÙˆØ±Ù‡ Ø´Ùˆ'); return; }

  const adFn = findAdFunction();
  if(!adFn){
    alert('Ad SDK Ù†Ù‡ Ø¯ÛŒ Ú†Ù…ØªÙˆ Ø´ÙˆÛŒ (zone id/SDK twig check).');
    setStatus('Ad SDK not ready');
    return;
  }

  // prevent super-fast re-clicks
  const now = Date.now();
  if(now - lastAdStart < 5000){
    alert('Ù„Ø·ÙØ§Ù‹ Ù„Ú– ØµØ¨Ø± ÙˆÚ©Ú“Ø¦ Ù…Ø®Ú©Û Ù„Ù‡ Ø¯Û Ú†Û Ø¨Ù„ Ø§Ø¹Ù„Ø§Ù† ÙˆÚ«ÙˆØ±Ø¦.');
    return;
  }
  lastAdStart = now;

  // record impression (ad opened)
  recordImpression();

  setStatus('Ad loadingâ€¦');
  let rewarded = false;
  // Try calling patterns and handle promise or callbacks
  try {
    // 1) try typical call returning a Promise: show_ZONE('pop') or show_ZONE()
    let res;
    try { res = adFn('pop'); } catch(e1){
      try { res = adFn({ type: 'rewarded' }); } catch(e2){
        try { res = adFn(); } catch(e3){ res = undefined; }
      }
    }

    if(res && typeof res.then === 'function'){
      setStatus('Playing ad (promise) â€¦');
      await res; // resolves when ad complete
      rewarded = true;
      setStatus('Ad completed (promise)');
    } else {
      // 2) fallback: listen to common global callbacks created by some SDKs
      setStatus('Playing ad (callback mode) â€¦');
      const cbNames = ['onAdComplete','onReward','on_ad_complete','onRewarded','onAdClosed','onMonetagReward'];
      const originals = {};
      let cbTimer;
      for(const n of cbNames){ originals[n] = window[n]; window[n] = function(){ rewarded = true; clearTimeout(cbTimer); /* restore later */ }} ;
      // call ad
      try { adFn(); } catch(e){ console.warn('adFn call error',e); }
      // wait up to 25s for callback
      await new Promise((res) => cbTimer = setTimeout(res, 25000));
      // restore callbacks
      for(const n of cbNames){ window[n] = originals[n]; }
      if(rewarded) setStatus('Ad completed (callback)');
    }

    if(rewarded){
      // grant reward atomically
      await grantRewardAtomic(uid, REWARD_AMOUNT);
      alert(`âœ… ØªØ¨Ø±ÛŒÚ©! ØªØ§Ø³Ùˆ ${REWARD_AMOUNT.toFixed(2)} AFN ØªØ±Ù„Ø§Ø³Ù‡ Ú©Ú“Ù„.`);
    } else {
      setStatus('Ad not completed â€” no reward');
      alert('ÙˆÛŒÚ‰ÛŒÙˆ Ø¨Ø´Ù¾Ú“Û Ù†Ù‡ Ø´ÙˆÙ‡ ÛŒØ§ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡ Ø´ÙˆÙ‡ â€” Ø§Ù†Ø¹Ø§Ù… Ù†Ø´ÙŠ ÙˆØ±Ú©ÙˆÙ„ Ú©ÛØ¯Ø§ÛŒ.');
    }

  } catch(err){
    console.error('Ad flow error', err);
    setStatus('Ad error');
    alert('Ø¯ Ø§Ø¹Ù„Ø§Ù† Ù¾Ù‡ Ú†Ù„ÙˆÙ„Ùˆ Ú©Û ØªÛØ±ÙˆØªÙ†Ù‡ ÙˆØ´ÙˆÙ‡: ' + (err && err.message ? err.message : err));
  }
}

/* ----------------- Buttons ----------------- */

watchBtn.addEventListener('click', ()=> {
  setStatus('Ø¯ Ø§Ø¹Ù„Ø§Ù† Ù„Ù¾Ø§Ø±Ù‡ Ú†Ù…ØªÙˆ Ú©ÛÚ–Ø¦â€¦');
  playRewarded();
});

shareBtn.addEventListener('click', ()=>{
  if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user){ alert('Open inside Telegram to share'); return; }
  const myId = String(tg.initDataUnsafe.user.id);
  const botUsername = 'TimuriAppBot'; // <<< CHANGE to your bot username
  const link = `https://t.me/${botUsername}?start=${myId}`;
  try { tg.shareUrl(link); } catch(e){ navigator.clipboard.writeText(link); alert('Referral link copied: ' + link); }
});

txBtn.addEventListener('click', ()=> {
  txList.style.display = txList.style.display === 'none' ? 'block' : 'none';
});

/* ----------------- Kickoff ----------------- */
initFromTelegram();

/* if user not opened via Telegram, show Telegram login widget fallback */
if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user){
  // create Telegram login fallback button (will redirect to bot login URL)
  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.style.marginTop = '10px';
  btn.textContent = 'ğŸ” Ø¯ Telegram Ù„Ù‡ Ù„Ø§Ø±Û Ù†Ù†ÙˆØ²Ø¦';
  btn.onclick = ()=> {
    // open bot (Bot must have Web App button configured)
    const botUrl = 'https://t.me/TimuriAppBot'; // <<< CHANGE to your bot url
    window.open(botUrl, '_blank');
  };
  document.querySelector('.card').appendChild(btn);
}
</script>
</body>
</html>
